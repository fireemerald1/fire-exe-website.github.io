<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fire Exe - Guest Book</title>
    <link rel="icon" type="image/png" href="https://github.com/fireemerald1/bg/blob/main/fire%20exe%20logo%20no%20svg.png?raw=true">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fire-black': '#000000',
                        'fire-cyan': '#00ffff',
                        'fire-red': '#ff0000',
                    },
                },
            },
        };
    </script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        :root {
            --primary-color: #ff0000;
            --secondary-color: #00ffff;
            --accent-color: #ff3333;
            --text-color: #e0e0e0;
            --light-text: #a0a0a0;
            --bg-color: #000000;
            --card-bg: #1a1a1a;
            --border-color: #333333;
        }

        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Glowing Hover Effect */
        .glow:hover {
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
        }
        
        /* Animated Gradient Overlay */
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-overlay {
            background: linear-gradient(45deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 0, 0.1), rgba(0, 255, 255, 0.1));
            background-size: 200% 200%;
            animation: gradientMove 10s ease infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
            border: none;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: transparent;
            border-radius: 6px;
            border: none;
            opacity: 0;
            transition: opacity 0.3s ease, background 0.3s ease;
        }
        
        html:hover ::-webkit-scrollbar-track {
            background: #000000;
            border: 1px solid #333333;
        }
        
        html:hover ::-webkit-scrollbar-thumb {
            background: #ff0000;
            border: 2px solid #000000;
            opacity: 1;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #ff3333;
        }
        
        html {
            scrollbar-width: none;
        }
        
        html:hover {
            scrollbar-width: thin;
            scrollbar-color: #ff0000 #000000;
        }

        /* Logo Bounce Animation */
        #logo-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #000;
        }
        
        /* Guest Book Entry Styles */
        .guest-entry {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .guest-entry::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            z-index: 1;
        }

        .guest-entry:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        /* Auth Button Styles */
        .auth-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .auth-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: all 0.5s ease;
        }

        .auth-btn:hover::after {
            left: 100%;
        }

        /* Loading Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            border-left-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 80%;
            text-align: center;
            font-weight: 500;
        }
        
        /* Toast animation */
        @keyframes toastBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            10% { transform: translateX(-50%) translateY(-10px); }
            20% { transform: translateX(-50%) translateY(0); }
            30% { transform: translateX(-50%) translateY(-5px); }
            40% { transform: translateX(-50%) translateY(0); }
        }
        
        /* Message image container */
        .message-image-container {
            max-width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .message-image-container img {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .message-image-container img.error-image {
            border: 2px solid #ff0000;
            opacity: 0.7;
        }
        
        /* Toast types */
        .toast.info {
            border-left: 4px solid #00ffff;
        }
        
        .toast.success {
            border-left: 4px solid #00ff00;
            background-color: rgba(0, 20, 0, 0.9);
        }
        
        .toast.error {
            border-left: 4px solid #ff0000;
            background-color: rgba(20, 0, 0, 0.9);
            font-weight: bold;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            animation: toastBounce 0.8s ease;
        }

        /* Canvas background */
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        /* Tailwind Extensions */
        .bg-fire-red { background-color: #ff0000; }
        .bg-fire-cyan { background-color: #00ffff; }
        .bg-fire-black { background-color: #000000; }
        .text-fire-red { color: #ff0000; }
        .text-fire-cyan { color: #00ffff; }
        .border-fire-red { border-color: #ff0000; }
        .border-fire-cyan { border-color: #00ffff; }
        .hover\:bg-fire-red:hover { background-color: #ff0000; }
        .hover\:bg-fire-cyan:hover { background-color: #00ffff; }
        .hover\:text-fire-red:hover { color: #ff0000; }
        .hover\:text-fire-cyan:hover { color: #00ffff; }
    </style>
</head>
<body class="bg-fire-black text-white font-sans antialiased overflow-x-hidden">
    <!-- Logo Bounce Background -->
    <canvas id="logo-canvas"></canvas>

    <!-- Navbar -->
    <nav class="fixed top-0 w-full bg-fire-black/80 backdrop-blur-md z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center py-4">
            <a href="index.html" class="text-2xl font-bold text-fire-red mb-4 inline-block">Fire Exe</a>
            <button class="sm:hidden text-fire-cyan text-2xl focus:outline-none" id="menu-btn">â˜°</button>
            <ul class="hidden sm:flex space-x-6">
                <li><a href="index.html" class="text-white hover:text-fire-red transition-colors">Home</a></li>
                <li><a href="About_me.html" class="text-white hover:text-fire-red transition-colors">About Me</a></li>
                <li><a href="projects.html" class="text-white hover:text-fire-red transition-colors">Projects</a></li>
                <li><a href="contact.html" class="text-white hover:text-fire-red transition-colors">Contact</a></li>
                <li><a href="guestbook.html" class="text-fire-red hover:text-fire-cyan transition-colors">Guest Book</a></li>
            </ul>
        </div>
        <!-- Mobile Menu -->
        <ul class="hidden sm:hidden flex-col absolute top-16 left-0 w-full bg-fire-black/95 p-6 space-y-4" id="mobile-menu">
            <li><a href="index.html" class="text-white hover:text-fire-red transition-colors">Home</a></li>
            <li><a href="About_me.html" class="text-white hover:text-fire-red transition-colors">About Me</a></li>
            <li><a href="projects.html" class="text-white hover:text-fire-red transition-colors">Projects</a></li>
            <li><a href="contact.html" class="text-white hover:text-fire-red transition-colors">Contact</a></li>
            <li><a href="guestbook.html" class="text-fire-red hover:text-fire-cyan transition-colors">Guest Book</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pt-32 pb-16">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-bold text-fire-red mb-4">Guest Book</h1>
                <p class="text-lg text-fire-cyan mb-8">Sign in and leave your mark on my digital guest book!</p>
                
                <!-- Authentication Section -->
                <div id="auth-container" class="bg-fire-black/70 backdrop-blur-md p-8 rounded-xl border border-gray-800 shadow-2xl mb-8">
                    <div id="login-container" class="text-center">
                        <h2 class="text-2xl font-bold text-fire-cyan mb-6">Sign In to Leave a Message</h2>
                        <p class="text-gray-400 mb-6">Please sign in with one of the following providers:</p>
                        <div class="flex flex-col sm:flex-row justify-center gap-4">
                            <button id="google-login" class="flex items-center justify-center bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">
                                <i class="fab fa-google text-xl mr-2"></i> Sign in with Google
                            </button>
                            <button id="github-login" class="flex items-center justify-center bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-all transform hover:scale-105">
                                <i class="fab fa-github text-xl mr-2"></i> Sign in with GitHub
                            </button>
                        </div>
                    </div>
                    
                    <div id="user-container" class="hidden">
                        <!-- User info and message form in a side-by-side layout -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Left side: User info and sign out -->
                            <div class="bg-fire-black/90 p-6 rounded-xl border-2 border-gray-800">
                                <div class="flex flex-col h-full">
                                    <div class="flex items-center mb-4">
                                        <div class="w-16 h-16 overflow-hidden rounded-full border-2 border-fire-cyan mr-4">
                                            <img id="user-photo" src="" alt="Profile" class="w-full h-full object-cover">
                                        </div>
                                        <div class="text-left">
                                            <p class="text-white text-lg">Signed in as <span id="user-name" class="text-fire-cyan font-bold"></span></p>
                                        </div>
                                    </div>
                                    <div class="mt-auto">
                                        <button id="sign-out" class="w-full bg-fire-red hover:bg-fire-red/80 text-white font-bold py-2 px-6 rounded-lg transition-all">
                                            Sign Out
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right side: Message form -->
                            <div class="bg-fire-black/90 p-6 rounded-xl border-2 border-gray-800">
                                <form id="message-form" class="h-full flex flex-col">
                                    <div class="flex-grow mb-4">
                                        <textarea id="message-input" class="w-full h-full p-4 rounded-lg bg-gray-900 border border-gray-700 text-white focus:border-fire-cyan focus:ring-2 focus:ring-fire-cyan/50 focus:outline-none transition-all" placeholder="Write your message here... You can add ONE image using [(https://example.com/image.jpg)] format." maxlength="500" required></textarea>
                                        <div class="text-right text-sm text-gray-500 mt-1">
                                            <span id="char-count">0</span>/500 characters
                                        </div>
                                    </div>
                                    <button type="submit" class="bg-fire-cyan hover:bg-fire-cyan/80 text-black font-bold py-3 px-8 rounded-lg transition-all transform hover:scale-105">
                                        <i class="fas fa-paper-plane mr-2"></i> Post Message
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Guest Book Entries -->
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-fire-cyan mb-6">Recent Messages</h2>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="flex justify-center my-12">
                        <div class="loading-spinner"></div>
                    </div>
                    
                    <!-- Entries Container -->
                    <div id="entries-container" class="hidden space-y-6">
                        <!-- Entries will be added here dynamically -->
                    </div>
                    
                    <!-- No Entries Message -->
                    <div id="no-entries-message" class="hidden text-center py-12">
                        <p class="text-xl text-gray-400">No messages yet. Be the first to sign the guest book!</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-fire-black py-12 border-t border-gray-800 relative">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            <div>
                <h3 class="text-fire-red text-xl font-semibold mb-4">About</h3>
                <p class="text-gray-400">Beginner programmer from Indonesia, exploring development and creation.</p>
                <p class="text-gray-400 mt-4">Fun Fact: i'm still a student</p>
            </div>
            <div>
                <h3 class="text-fire-red text-xl font-semibold mb-4">Quick Links</h3>
                <ul class="space-y-2">
                    <li><a href="index.html" class="text-gray-400 hover:text-fire-cyan transition-colors">Home</a></li>
                    <li><a href="About_me.html" class="text-gray-400 hover:text-fire-cyan transition-colors">About Me</a></li>
                    <li><a href="projects.html" class="text-gray-400 hover:text-fire-cyan transition-colors">Projects</a></li>
                    <li><a href="contact.html" class="text-gray-400 hover:text-fire-red transition-colors">Contact</a></li>
                    <li><a href="guestbook.html" class="text-gray-400 hover:text-fire-red transition-colors">Guest Book</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-fire-red text-xl font-semibold mb-4">Skills</h3>
                <ul class="space-y-2">
                    <li><span class="text-white">Python</span></li>
                    <li><span class="text-white">Geometry Dash</span></li>
                    <li><span class="text-white">Adobe Illustrator</span></li>
                    <li><a href="About_me.html" class="text-gray-400 hover:text-fire-cyan transition-colors">More Skills</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-fire-red text-xl font-semibold mb-4">Contact</h3>
                <ul class="space-y-2">
                    <li>Email: <a href="mailto:fireexecontact@gmail.com" class="text-gray-400 hover:text-fire-cyan transition-colors">fireexecontact@gmail.com</a></li>
                    <li class="text-gray-400">Location: Indonesia</li>
                </ul>
                <div class="flex space-x-4 mt-4">
                    <a href="https://github.com/fireemerald1" class="text-fire-cyan hover:text-fire-red transition-colors"><i class="fab fa-github text-2xl"></i></a>
                    <a href="https://www.youtube.com/@fireexeGD" class="text-fire-cyan hover:text-fire-red transition-colors"><i class="fab fa-youtube text-2xl"></i></a>
                    <a href="https://discord.com/users/1330170447588888651" class="text-fire-cyan hover:text-fire-red transition-colors"><i class="fab fa-discord text-2xl"></i></a>
                </div>
            </div>
        </div>
        <div class="text-center mt-8 pt-8 border-t border-gray-800 text-gray-400">
            2025 Fire Exe Property. All Rights Reserved.
            <p><a href="contact.html" class="text-gray-400 hover:text-fire-cyan transition-colors">Contact Me</a></p>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <button id="back-to-top" class="fixed bottom-8 right-8 bg-fire-red text-fire-black p-4 rounded-full shadow-lg hover:bg-fire-cyan transition-all duration-300 glow hidden">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Ad Container -->
    <div class="ad-container fixed w-80 z-50 hidden transition-all duration-300">
        <div class="relative rounded-lg overflow-hidden shadow-2xl glass">
            <img src="" alt="Advertisement" class="ad-image w-full h-auto">
            <div class="ad-overlay absolute inset-0 bg-fire-black/60 opacity-0 hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                <a href="#" class="ad-button bg-fire-cyan text-fire-black px-6 py-3 rounded-lg font-medium hover:bg-fire-red transition-all duration-300 glow">Visit Now</a>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <!-- Load Firebase Configuration from external file -->
    <script src="firebase-config.js"></script>
    <script>

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Admin user IDs - add your Firebase user ID here after you sign in once
        const adminUserIds = [
            "rMm3PenKgMeeh2sxw67ltZK5rfj1"
        ];
        
        // DOM Elements
        const userSignedOutElement = document.getElementById('login-container');
        const userSignedInElement = document.getElementById('user-container');
        const userPhotoElement = document.getElementById('user-photo');
        const userNameElement = document.getElementById('user-name');
        const signInGoogleButton = document.getElementById('google-login');
        const signInGithubButton = document.getElementById('github-login');
        const signOutButton = document.getElementById('sign-out');
        const messageFormContainer = document.getElementById('message-form');
        const guestMessageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const charCount = document.getElementById('char-count');
        const loadingSpinner = document.getElementById('loading-spinner');
        const entriesContainer = document.getElementById('entries-container');
        const noEntriesMessage = document.getElementById('no-entries-message');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        // Character counter for message input
        messageInput.addEventListener('input', function() {
            const currentLength = this.value.length;
            charCount.textContent = currentLength;
            
            // Change color when approaching limit
            if (currentLength >= 450) {
                charCount.classList.add('text-fire-red');
            } else if (currentLength >= 400) {
                charCount.classList.add('text-yellow-500');
                charCount.classList.remove('text-fire-red');
            } else {
                charCount.classList.remove('text-yellow-500', 'text-fire-red');
            }
        });
        
        // Check if user is already signed in
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                userSignedOutElement.classList.add('hidden');
                userSignedInElement.classList.remove('hidden');
                
                // Set user info
                userNameElement.textContent = user.displayName || 'User';
                userPhotoElement.src = user.photoURL || 'https://ui-avatars.com/api/?name=' + (user.displayName || 'User') + '&background=0077ff&color=ffffff';
                
                // Check if user is admin and log UID (for adding to admin list)
                console.log('Current user UID:', user.uid);
                isAdmin = adminUserIds.includes(user.uid);
                
                // Load entries
                loadEntries();
            } else {
                // User is signed out
                userSignedOutElement.classList.remove('hidden');
                userSignedInElement.classList.add('hidden');
                
                // Load entries (even when signed out, to view them)
                loadEntries();
            }
        });
        
        // Handle redirect result when the page loads
        // This is needed for the redirect authentication method
        firebase.auth().getRedirectResult().then((result) => {
            if (result.user) {
                // User just signed in with a redirect
                showToast('Signed in successfully!', 'success');
                // Reload the page to ensure UI updates correctly
                location.reload();
            }
        }).catch((error) => {
            console.error('Error with redirect sign-in:', error);
            // Show more detailed error message for debugging
            if (error.code === 'auth/unauthorized-domain') {
                showToast('Error: This domain is not authorized in Firebase. Add localhost to authorized domains in Firebase console.', 'error');
                console.warn('You need to add ' + window.location.hostname + ' to authorized domains in Firebase console.');
            } else if (error.code !== 'auth/cancelled-popup-request') {
                showToast('Error signing in: ' + error.message, 'error');
            }
        });
        
        // Sign in with Google
        signInGoogleButton.addEventListener('click', () => {
            showToast('Attempting to sign in with Google...', 'info');
            console.log('Attempting Google sign-in');
            
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Add scopes for better user identification
            provider.addScope('profile');
            provider.addScope('email');
            
            // Force account selection even if user is already signed in
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            
            // Always use popup for testing to see immediate errors
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Successfully signed in
                    console.log('Google sign-in successful:', result.user.displayName);
                    showToast('Signed in successfully as ' + result.user.displayName, 'success');
                })
                .catch((error) => {
                    console.error('Detailed Google sign-in error:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    // Show more specific error messages
                    if (error.code === 'auth/popup-blocked') {
                        showToast('Popup was blocked. Please allow popups for this site.', 'error');
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        showToast('Sign-in was cancelled. Please try again.', 'info');
                    } else if (error.code === 'auth/unauthorized-domain') {
                        showToast('This domain (' + window.location.hostname + ') is not authorized in Firebase.', 'error');
                    } else {
                        showToast('Error signing in: ' + error.message, 'error');
                    }
                });
        });
        
        // Sign in with GitHub
        signInGithubButton.addEventListener('click', () => {
            showToast('Attempting to sign in with GitHub...', 'info');
            console.log('Attempting GitHub sign-in');
            
            const provider = new firebase.auth.GithubAuthProvider();
            
            // Add scopes for better user identification
            provider.addScope('user');
            
            // Force account selection even if user is already signed in
            provider.setCustomParameters({
                'allow_signup': 'true'
            });
            
            // Always use popup for testing to see immediate errors
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Successfully signed in
                    console.log('GitHub sign-in successful:', result.user.displayName);
                    showToast('Signed in successfully as ' + result.user.displayName, 'success');
                })
                .catch((error) => {
                    console.error('Detailed GitHub sign-in error:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    // Show more specific error messages
                    if (error.code === 'auth/popup-blocked') {
                        showToast('Popup was blocked. Please allow popups for this site.', 'error');
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        showToast('Sign-in was cancelled. Please try again.', 'info');
                    } else if (error.code === 'auth/unauthorized-domain') {
                        showToast('This domain (' + window.location.hostname + ') is not authorized in Firebase.', 'error');
                    } else if (error.code === 'auth/account-exists-with-different-credential') {
                        showToast('An account already exists with the same email address but different sign-in credentials.', 'error');
                    } else {
                        showToast('Error signing in: ' + error.message, 'error');
                    }
                });
        });

        // Sign out
        signOutButton.addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    showToast('Signed out successfully!', 'success');
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                    showToast('Error signing out. Please try again.', 'error');
                });
        });
        
        // Submit message
        guestMessageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const user = auth.currentUser;
            if (!user) {
                showToast('Please sign in to post a message.', 'info');
                return;
            }
            
            const message = messageInput.value.trim();
            if (!message) {
                showToast('Please enter a message.', 'info');
                return;
            }
            
            // Check for bad words
            if (await containsBadWords(message)) {
                showToast('Your message contains inappropriate language. Please revise and try again.', 'error');
                return;
            }
            
            // Add message to Firestore
            db.collection('guestbook').add({
                userId: user.uid,
                name: user.displayName || 'Anonymous',
                photoURL: user.photoURL || '',
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Clear form and show success message
                messageInput.value = '';
                charCount.textContent = '0';
                charCount.classList.remove('text-yellow-500', 'text-fire-red');
                showToast('Message posted successfully!', 'success');
                
                // Reload entries
                loadEntries();
            })
            .catch((error) => {
                console.error('Error posting message:', error);
                showToast('Error posting message. Please try again.', 'error');
            });
        });
        
        // Bad words filter with character substitution detection
        async function containsBadWords(text) {
            try {
                // Fetch bad words list
                const response = await fetch('https://raw.githubusercontent.com/fireemerald1/asdbhjawbhdkjabnsdkjbwa/refs/heads/main/badwords.json');
                const data = await response.json();
                const badWords = data.forbidden_words || [];
                
                if (!badWords.length) {
                    console.warn('Bad words list is empty or invalid');
                    return false;
                }
                
                // Normalize text for checking (lowercase, remove extra spaces)
                let normalizedText = text.toLowerCase().replace(/\s+/g, ' ');
                
                // Create a version of the text with common character substitutions replaced
                let substitutedText = normalizedText
                    .replace(/1/g, 'i')
                    .replace(/0/g, 'o')
                    .replace(/3/g, 'e')
                    .replace(/4/g, 'a')
                    .replace(/5/g, 's')
                    .replace(/7/g, 't')
                    .replace(/8/g, 'b')
                    .replace(/9/g, 'g')
                    .replace(/@/g, 'a')
                    .replace(/\$/g, 's')
                    .replace(/\+/g, 't')
                    .replace(/\(/g, 'c')
                    .replace(/\)/g, 'o')
                    .replace(/\*/g, 'a')
                    .replace(/!/g, 'i');
                
                // Only use spaced/special character matching for longer bad words
                const MIN_SPACED_LENGTH = 5;
                
                for (const badWord of badWords) {
                    // Check for exact matches with word boundaries (whole words only)
                    const regex = new RegExp('\\b' + badWord + '\\b', 'i');
                    if (regex.test(normalizedText) || regex.test(substitutedText)) {
                        return true;
                    }

                    // Only apply spaced/special character matching for longer bad words
                    if (badWord.length >= MIN_SPACED_LENGTH) {
                        // Add word boundaries to spacedRegex to avoid matching substrings inside other words
                        const spacedRegex = new RegExp('\\b' + badWord.split('').join('[\\s\\W_]*') + '\\b', 'i');
                        if (spacedRegex.test(normalizedText) || spacedRegex.test(substitutedText)) {
                            return true;
                        }
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error checking bad words:', error);
                return false; // In case of error, allow the message to be posted
            }
        }
        
        // Function to sanitize HTML and process image tags
        function processMessageContent(message) {
            // First escape HTML to prevent any HTML injection
            let sanitized = message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Look for image pattern [(https://example.com/image.jpg)]
            const imagePattern = /\[\((https?:\/\/[^\s]+\.(png|jpg|jpeg|gif|webp))\)\]/i;
            const imageMatch = sanitized.match(imagePattern);
            
            let imageHtml = '';
            
            // If there's an image match, extract it and create image HTML
            if (imageMatch) {
                const imageUrl = imageMatch[1];
                // Remove the image tag from the text
                sanitized = sanitized.replace(imageMatch[0], '');
                // Create image HTML with safety measures
                imageHtml = `<div class="message-image-container mb-3">
                    <img src="${imageUrl}" alt="User shared image" class="max-w-full rounded-lg shadow-md" 
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/400x300?text=Image+Error'; this.classList.add('error-image');"
                         loading="lazy">
                </div>`;
            }
            
            // Return both the image HTML and sanitized text
            return {
                imageHtml: imageHtml,
                textHtml: sanitized.trim()
            };
        }
        
        // Load guest book entries
        function loadEntries() {
            loadingSpinner.classList.remove('hidden');
            entriesContainer.classList.add('hidden');
            noEntriesMessage.classList.add('hidden');
            
            db.collection('guestbook')
                .orderBy('timestamp', 'desc')
                .get()
                .then((querySnapshot) => {
                    // Hide loading spinner
                    loadingSpinner.classList.add('hidden');
                    
                    // Clear existing entries
                    entriesContainer.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        // Show no entries message
                        noEntriesMessage.classList.remove('hidden');
                        return;
                    }
                    
                    // Show entries container
                    entriesContainer.classList.remove('hidden');
                    
                    // Get current user
                    const currentUser = auth.currentUser;
                    const isAdmin = currentUser ? adminUserIds.includes(currentUser.uid) : false;
                    
                    // Process each entry
                    querySnapshot.forEach((doc) => {
                        const entry = doc.data();
                        const entryId = doc.id;
                        const timestamp = entry.timestamp ? entry.timestamp.toDate() : new Date();
                        const formattedDate = new Intl.DateTimeFormat('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: 'numeric',
                            minute: 'numeric',
                            hour12: true
                        }).format(timestamp);
                        
                        // Process message content to sanitize HTML and handle image embedding
                        const processedContent = processMessageContent(entry.message);
                        
                        // Create entry element
                        const entryElement = document.createElement('div');
                        entryElement.className = 'guest-entry bg-fire-black/70 backdrop-blur-md p-6 rounded-xl border border-gray-800 shadow-xl';
                        entryElement.innerHTML = `
                            <div class="flex items-start">
                                <div class="flex-shrink-0 mr-4">
                                    <div class="w-12 h-12 overflow-hidden rounded-full border border-fire-cyan">
                                        <img src="${entry.photoURL || 'https://ui-avatars.com/api/?name=' + entry.name + '&background=0077ff&color=ffffff'}" 
                                             alt="${entry.name}" class="w-full h-full object-cover">
                                    </div>
                                </div>
                                <div class="flex-grow">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-fire-cyan font-bold text-lg">${entry.name}</h3>
                                        <span class="text-gray-500 text-sm">${formattedDate}</span>
                                    </div>
                                    
                                    <!-- Image content (if any) -->
                                    ${processedContent.imageHtml}
                                    
                                    <!-- Text content (sanitized) -->
                                    <p class="text-white mb-4">${processedContent.textHtml}</p>
                                    
                                    ${entry.editedAt ? `<p class="text-gray-500 text-xs italic">Edited by ${entry.editedBy || 'user'} on ${new Intl.DateTimeFormat('en-US', { dateStyle: 'medium', timeStyle: 'short' }).format(entry.editedAt.toDate())}</p>` : ''}
                                </div>
                            </div>
                        `;

                        // Add admin controls if user is admin
                        if (isAdmin) {
                            const adminControls = document.createElement('div');
                            adminControls.className = 'mt-4 pt-4 border-t border-gray-800 flex justify-end space-x-4';
                            adminControls.innerHTML = `
                                <button class="delete-entry-btn text-fire-red hover:text-white transition-colors">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                <button class="edit-entry-btn text-fire-cyan hover:text-white transition-colors">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            `;
                            entryElement.appendChild(adminControls);
                        }

                        // Add entry to container
                        entriesContainer.appendChild(entryElement);
                        
                        // Add event listeners for admin controls
                        if (isAdmin) {
                            // Delete button
                            const deleteBtn = entryElement.querySelector('.delete-entry-btn');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', () => {
                                    if (confirm('Are you sure you want to delete this message?')) {
                                        deleteEntry(entryId);
                                    }
                                });
                            }
                            
                            // Edit button
                            const editBtn = entryElement.querySelector('.edit-entry-btn');
                            if (editBtn) {
                                editBtn.addEventListener('click', () => {
                                    editEntry(entryId, entry);
                                });
                            }
                        }
                    });
                })
                .catch((error) => {
                    console.error('Error loading entries:', error);
                    loadingSpinner.classList.add('hidden');
                    showToast('Error loading messages. Please try again.');
                });
        }

        // Function to delete an entry
        function deleteEntry(entryId) {
            db.collection('guestbook').doc(entryId).delete()
                .then(() => {
                    showToast('Message deleted successfully!', 'success');
                    // Reload entries to update the UI
                    loadEntries();
                })
                .catch((error) => {
                    console.error('Error deleting message:', error);
                    showToast('Error deleting message: Missing or insufficient permissions.', 'error');
                });
        }
        
        // Function to edit an entry
        function editEntry(entryId, entry) {
            const newMessage = prompt('Edit message: (You can add one image using [(https://example.com/image.jpg)] format)', entry.message);
            
            if (newMessage === null || newMessage.trim() === '' || newMessage === entry.message) {
                return; // User cancelled or didn't change the message
            }
            
            const currentUser = auth.currentUser;
            
            // Sanitization happens when displaying the message, not when storing it
            // This allows us to maintain the original format including image links
            db.collection('guestbook').doc(entryId).update({
                message: newMessage,
                editedAt: firebase.firestore.FieldValue.serverTimestamp(),
                editedBy: currentUser ? currentUser.displayName : 'Admin'
            })
            .then(() => {
                showToast('Message edited successfully!', 'success');
                // Reload entries to update the UI
                loadEntries();
            })
            .catch((error) => {
                console.error('Error editing message:', error);
                showToast('Error editing message: Missing or insufficient permissions.', 'error');
            });
        }
        
        // Function to show toast notification with type (success, error, info)
        function showToast(message, type = 'info') {
            // Get appropriate icon based on type
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle mr-2"></i>';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle mr-2"></i>';
                    break;
                case 'info':
                default:
                    icon = '<i class="fas fa-info-circle mr-2"></i>';
                    break;
            }
            
            // Set message with icon
            toastMessage.innerHTML = icon + message;
            
            // Remove any existing classes
            toast.classList.remove('success', 'error', 'info');
            
            // Add the type class
            toast.classList.add(type);
            toast.classList.add('show');
            
            // Log to console as well
            if (type === 'error') {
                console.error('TOAST:', message);
            } else if (type === 'success') {
                console.log('TOAST:', message);
            } else {
                console.info('TOAST:', message);
            }
            
            // Hide toast after 5 seconds for errors, 3 seconds for others
            setTimeout(() => {
                toast.classList.remove('show');
            }, type === 'error' ? 5000 : 3000);
        }

        // Logo Bounce Animation
        function initLogoBounceAnimation() {
            const canvas = document.getElementById('logo-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas dimensions
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Logo SVG path data
            const logoPath = "M598.29,699.41c-7.64,25.64-18.81,50.84-22.13,77.03-5.38,42.47-2.74,90.23,41.54,107.76,27.96,11.08,69.77,7.66,97.43-5.69,42.79-20.66,52.69-65.25,43.59-111.8-10.65-54.5-24.88-108.56-31.16-163.54-2.94-25.73,9.16-53.19,14.45-79.86,5.07,.03,10.14,.07,15.21,.1,6.47,16.93,13.9,33.57,19.26,50.84,25.02,80.66,100.71,126.5,182.73,110.07,58.34-11.69,95.87-67.23,83.34-125.53-4.63-21.56-12.95-42.33-19.7-63.83,115.28-4.15,209.82,154.82,161.75,270.19-12.85,30.83-29.38,60.14-41.84,91.11-23.16,57.53-2.42,107.58,49.86,124.52,56.2,18.21,120.02-12.65,134.04-67.73,6.77-26.6,6.59-54.97,10.52-91.51,49.11,43.08,47.67,93.2,43.16,140.52-15.5,162.46-94.2,288.98-227.18,382.21-111.78,78.37-348.53,63.66-473.3-28.83-175.57-130.16-238.75-372.58-146.69-571.01,10.39-22.4,33.14-39.08,50.16-58.41,4.99,4.46,9.98,8.92,14.98,13.38Z";
            
            // Create a new Image object for the logo
            function createLogoImage(color, size) {
                // Create a temporary canvas to draw the SVG
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Set the canvas size based on the desired logo size
                tempCanvas.width = size;
                tempCanvas.height = size;
                
                // Create a path from the SVG data
                const path = new Path2D(logoPath);
                
                // Scale and center the path to fit the canvas
                tempCtx.translate(size/2, size/2);
                tempCtx.scale(size/1500, size/1500); // Scale based on original SVG viewBox
                tempCtx.translate(-937, -940); // Center based on original SVG viewBox
                
                // Fill the path with the specified color
                tempCtx.fillStyle = color;
                tempCtx.fill(path);
                
                // Create an image from the canvas
                const img = new Image();
                img.src = tempCanvas.toDataURL();
                return img;
            }
            
            // Create logo images in red and cyan
            const redLogoImg = createLogoImage('#ff0000', 50);
            const cyanLogoImg = createLogoImage('#00ffff', 50);
            
            // Logo objects array
            const logos = [];
            const logoCount = 30; // Number of bouncing logos
            
            // Initialize logos
            function initLogos() {
                for (let i = 0; i < logoCount; i++) {
                    const isRed = Math.random() > 0.5;
                    const size = 30 + Math.random() * 40; // Random size between 30 and 70
                    
                    logos.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: (Math.random() - 0.5) * 4,
                        vy: (Math.random() - 0.5) * 4,
                        size: size,
                        color: isRed ? '#ff0000' : '#00ffff',
                        img: isRed ? redLogoImg : cyanLogoImg,
                        rotation: Math.random() * Math.PI * 2,
                        rotationSpeed: (Math.random() - 0.5) * 0.1,
                        opacity: 0.7 + Math.random() * 0.3
                    });
                }
            }
            
            // Animation loop
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Update and draw logos
                for (let i = 0; i < logos.length; i++) {
                    const logo = logos[i];
                    
                    // Update position
                    logo.x += logo.vx;
                    logo.y += logo.vy;
                    logo.rotation += logo.rotationSpeed;
                    
                    // Bounce off walls
                    if (logo.x < 0 || logo.x > canvas.width - logo.size) {
                        logo.vx = -logo.vx;
                        // Add a small random adjustment to prevent logos from getting stuck
                        logo.vx += (Math.random() - 0.5) * 0.5;
                    }
                    if (logo.y < 0 || logo.y > canvas.height - logo.size) {
                        logo.vy = -logo.vy;
                        // Add a small random adjustment
                        logo.vy += (Math.random() - 0.5) * 0.5;
                    }
                    
                    // Check collisions with other logos
                    for (let j = i + 1; j < logos.length; j++) {
                        const otherLogo = logos[j];
                        const dx = otherLogo.x - logo.x;
                        const dy = otherLogo.y - logo.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        const minDistance = (logo.size + otherLogo.size) / 2;
                        
                        if (distance < minDistance) {
                            // Calculate collision response
                            const angle = Math.atan2(dy, dx);
                            const targetX = logo.x + Math.cos(angle) * minDistance;
                            const targetY = logo.y + Math.sin(angle) * minDistance;
                            const ax = (targetX - otherLogo.x) * 0.05;
                            const ay = (targetY - otherLogo.y) * 0.05;
                            
                            logo.vx -= ax;
                            logo.vy -= ay;
                            otherLogo.vx += ax;
                            otherLogo.vy += ay;
                            
                            // Add slight rotation on collision
                            logo.rotationSpeed += (Math.random() - 0.5) * 0.02;
                            otherLogo.rotationSpeed += (Math.random() - 0.5) * 0.02;
                        }
                    }
                    
                    // Draw logo with rotation
                    ctx.save();
                    ctx.translate(logo.x + logo.size/2, logo.y + logo.size/2);
                    ctx.rotate(logo.rotation);
                    ctx.globalAlpha = logo.opacity;
                    
                    // Draw the logo image
                    ctx.drawImage(
                        logo.img,
                        -logo.size/2,
                        -logo.size/2,
                        logo.size,
                        logo.size
                    );
                    
                    // Add glow effect
                    const glow = ctx.createRadialGradient(
                        0, 0, 0,
                        0, 0, logo.size
                    );
                    glow.addColorStop(0, logo.color === '#ff0000' ? 'rgba(255, 0, 0, 0.2)' : 'rgba(0, 255, 255, 0.2)');
                    glow.addColorStop(1, 'rgba(0, 0, 0, 0)');
                    
                    ctx.fillStyle = glow;
                    ctx.fillRect(-logo.size, -logo.size, logo.size * 2, logo.size * 2);
                    
                    ctx.restore();
                }
                
                requestAnimationFrame(animate);
            }
            
            // Wait for images to load before starting animation
            let imagesLoaded = 0;
            function checkImagesLoaded() {
                imagesLoaded++;
                if (imagesLoaded >= 2) { // We have 2 images (red and cyan)
                    initLogos();
                    animate();
                }
            }
            
            redLogoImg.onload = checkImagesLoaded;
            cyanLogoImg.onload = checkImagesLoaded;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize logo bounce animation
            initLogoBounceAnimation();
            
            // Show info message about image embedding
            showToast('You can now embed one image in your messages using [(https://example.com/image.jpg)] format!', 'info');
            
            loadEntries();
            
            // Refresh entries every 60 seconds
            setInterval(loadEntries, 60000);
            
            // Print current user ID to console when signed in (for admin setup)
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('Your user ID for admin setup:', user.uid);
                    
                    // Check if user is admin
                    const isAdmin = adminUserIds.includes(user.uid);
                    if (isAdmin) {
                        showToast('Signed in as admin', 'success');
                    }
                }
            });
            
            // Mobile menu toggle
            const menuBtn = document.getElementById('menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            menuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                mobileMenu.classList.toggle('flex');
            });
        });

        // Handle window resize for background
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('logo-canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    </script>
</body>
</html>
